{{- if .Values.gateway }}
{{- required "`gateway` value has been deprecated.  Please use the new format in the `gateways` value." "" }}
{{- end }}

{{- range $name, $values := .Values.gateways }}
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ $name }}
  namespace: {{ $.Release.Namespace }}
spec:
  selector:
  {{- $values.selector | default (dict) | toYaml | nindent 4 }}
  servers:
  {{- $uniqueHosts := dict }}
  {{- range $servers := $values.servers }}
    {{- range $host := .hosts }}
      {{- $host := tpl . $ }}
      {{- if not (hasKey $uniqueHosts $host) }}
        {{- $uniqueHosts = merge $uniqueHosts (dict $host true) }}
      {{- end }} 
    {{- end }}
  {{- end }}
  {{- range $host, $_ := $uniqueHosts }}
  {{- if $values.autoHttpRedirect.enabled }}
  - hosts:
    - "{{ $host }}"
    port:
      name: http
      number: 8080
      protocol: HTTP
    tls:
      httpsRedirect: true
  {{- end }}
  {{- end }}
  {{- $values.servers | default (dict) | toYaml | nindent 2 }}
{{- end }}