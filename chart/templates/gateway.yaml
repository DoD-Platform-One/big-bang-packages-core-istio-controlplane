{{- if .Values.gateway }}
{{- required "`gateway` value has been deprecated.  Please use the new format in the `gateways` value." "" }}
{{- end }}

{{- range $name, $values := .Values.gateways }}
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ $name }}
  namespace: {{ $.Release.Namespace }}
spec:
  selector:
    {{- $values.selector | default (dict) | toYaml | nindent 4 }}
  servers:
{{- range .servers }}
  - hosts:
{{- range .hosts }}
    - "{{ tpl . $ }}"
{{- end }}
{{- if and ($values.autoHttpRedirect.enabled) (eq .port.protocol "HTTPS") }}
    port:
      name: http
      number: 8080
      protocol: HTTP
    tls:
      httpsRedirect: true
{{- end }}
    port:
      name: {{ .port.name }}
      number: {{ .port.number }}
      protocol: {{ .port.protocol }}
{{- if or (and ($values.autoHttpRedirect.enabled) (eq .port.protocol "HTTP")) (.tls) }}
    tls:
{{- if or (and ($values.autoHttpRedirect.enabled) (eq .port.protocol "HTTP")) (.tls.httpsRedirect) }}
      httpsRedirect: true
{{- else }}
      httpsRedirect: false
{{- end }}
{{- end }}
{{- end }}
{{- end }}